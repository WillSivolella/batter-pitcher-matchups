---
title: "Untitled"
author: "Samuel Brown"
date: "2023-09-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set directory
setwd("C:/Users/brown/Documents/GitHub/batter-pitcher-matchups")
# Load packages
library(tidyverse)
```

```{r}
files <- list.files(pattern = "2022", full.names = TRUE)
pitcher_ids <- read.csv("pitcher_ids.csv")
batter_ids <- read.csv("hitter_ids.csv")
all_pitches <- Reduce(rbind, lapply(files, read.csv)) %>%
  filter(balls < 4 & strikes < 3) %>%
  unite("count", balls, strikes, remove = FALSE) %>%
  unite("matchup", stand, p_throws, remove = FALSE) %>% 
  inner_join(pitcher_ids, by = "pitcher")

swings_2022_1 <- read.csv('swings_2022_4.csv') %>% 
  select(-delta_home_win_exp, -delta_run_exp)
write.csv(swings_2022_1, 'swings_2022_4.csv')
```

# Approach 1: Cluster by pitch: Cluster by pitch and predict batter success against a pitch and go from there
```{r}
# Get all pitches by pitcher and average measurements
repertoires <- all_pitches %>% 
  select(c(pitcher, pitcher_name, p_throws, pitch_type, release_speed, release_pos_x, release_pos_z, pfx_x, 
           pfx_z, release_spin_rate, release_extension, spin_axis)) %>% 
  group_by(pitcher, pitcher_name, pitch_type, p_throws) %>% 
  summarize(ct = n(),
            velo = mean(release_speed, na.rm = T),
            x_move = mean(pfx_x, na.rm = T),
            z_move = mean(pfx_z, na.rm = T),
            x_rel = mean(release_pos_x, na.rm = T),
            z_rel = mean(release_pos_z, na.rm = T),
            spin_rate = mean(release_spin_rate, na.rm = T),
            spin_axis = mean(spin_axis, na.rm = T),
            extension = mean(release_extension, na.rm = T),
            .groups = "keep") %>% 
  ungroup(pitcher, pitch_type, p_throws) %>% 
  mutate(perc = ct/sum(ct)) %>% 
  ungroup() %>% 
  relocate(perc, .before = velo) %>% 
  filter(ct >= 50) 
#%>% 
#  pivot_wider(id_cols = pitcher_name,
#              names_from = pitch_type,
#              values_from = c(perc, velo, x_move, z_move, x_rel, z_rel, spin_rate, spin_axis, extension)) 

repertoires
```

```{r}
scale2 <- function(x) (x - mean(x, na.rm = T)) / sd(x, na.rm = T)

# Make repertoires into z scores after adjusting for lefties and righties having opposite values
rep_zs <- repertoires %>% 
  mutate(x_rel = ifelse(p_throws == "L", -1 * x_rel, x_rel),
         x_move = ifelse(p_throws == "L", -1 * x_move, x_move),
         spin_axis = ifelse(p_throws == "L", -1* (spin_axis - 180) + 180, spin_axis),
         across(where(is.numeric) & !pitcher & !ct & !perc, scale2),
         x_rel = ifelse(p_throws == "L", -1 * x_rel, x_rel),
         x_move = ifelse(p_throws == "L", -1 * x_move, x_move),
         spin_axis = ifelse(p_throws == "L", -1* (spin_axis - 180) + 180, spin_axis)
         )

rep_zs
```

### Make clusters of all pitches and then get a vector representation of each pitcher season. Run K-Means or hierarchical clustering on these vectors. 
```{r}
# PCA first??
```


```{r}
pitch_clusters <- rep_zs %>% 
  select(-c(1:6)) %>% 
  dist() %>%
  hclust(method = "complete")
plot(as.dendrogram(pitch_clusters), main = "HC with Complete Linkage")


# Graph clusters by movement
cbind(repertoires, clust = cutree(pitch_clusters, 24)) %>% 
  #filter(clust %in% c(1, 2, 3, 4, 5)) %>% 
  filter(p_throws == "L") %>% 
  mutate(clust = as.factor(clust)) %>% 
  ggplot(aes(x = x_move, y = z_move, color = clust)) +
  geom_point(alpha = .6)

# Look at clusters by mean stats
cbind(repertoires, clust = cutree(pitch_clusters, 24)) %>% 
  mutate(clust = as.factor(clust)) %>%
  group_by(clust) %>% 
  summarize(ct = n(),
            across(where(is.numeric) & !pitcher & !ct & !perc, mean))
```

```{r}
# Look at the pitchers by cluster
reps_2 <- cbind(repertoires, clust = cutree(pitch_clusters, 24)) %>% 
  group_by(pitcher_name, p_throws, clust) %>% 
  summarize(perc = sum(perc), .groups = 'keep') %>% 
  arrange(clust) %>% 
  pivot_wider(id_cols = c(pitcher_name, p_throws),
              names_from = clust,
              names_prefix = "clust_",
              values_from = perc,
              values_fill = 0) %>% 
  arrange(pitcher_name) %>% 
  ungroup()

reps_2
```

### Predict performance against each pitch



##########################################################################################################
# Approach 2: Cluster by pitcher: Fastball velo, fourseam vs sinker, secondary usage, arm slot, etc.
```{r}
all_pitches %>% 
  select(c(pitcher, pitcher_name, p_throws, pitch_type, release_speed, release_pos_x, release_pos_z, pfx_x, 
           pfx_z, release_spin_rate, release_extension, spin_axis)) %>% 
  group_by(pitcher, pitcher_name, pitch_type, p_throws) %>% 
  summarize(ct = n(),
            velo = mean(release_speed, na.rm = T),
            extension = mean(release_extension, na.rm = T),
            .groups = "keep") 


  fb = pitch_type %in% c("FA", "FF", "SI", "FC"),
         bb = pitch_type %in% c("CS", "CU", "SL", "KC"),
         offspeed = pitch_type %in% c("CH", "EP", "KN", "FS")
```



